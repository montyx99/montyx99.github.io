---
title: 3D printing - Klipper gyorstalpal√≥ (1. r√©sz - elm√©let)
layout: post
author: montyx
---
A Klipper nyomtat√≥ vez√©rl√©sben 2 fontos egys√©g vesz r√©szt: a Raspberry PI √©s a nyomtat√≥ alaplapja.A nyomtat√≥ alaplapj√°n van egy mikrokontroller, ami a nyomtat√≥ √∂sszes szenzor√°t, motorj√°t, motor driver√©t, f≈±t√©si √©s h≈±t√©si egys√©geit vez√©rli. A Marlin firmware √∫gy m≈±k√∂dik, hogy mindent megoldjon maga az MCU (mikrokontroller). Ugyanis egy slicer √°ltal el≈ë√°ll√≠tott gcode olyanokat tartalmaz, amiket m√©g ki kell sz√°molni geometri√°val √©s elemi koordin√°t√°kra le kell bontani.

Na most az SWX1 agya egy 8-bites MCU, az ATMEGA2560.

| ![ATmega2560 chip](/docs/assets/atmega2560.png) | 
|:--:| 
| *ATmega2560 chip* |

Ez kb. annyit tud, mint egy alap Arduino Uno. Semmivel sem t√∂bbet, legal√°bbis sz√°m√≠t√°si kapacit√°sban. Cser√©be marha sok l√°ba van.

| ![ATmega328 chip](/docs/assets/atmega328p.png) | 
|:--:| 
| *ATmega328 chip* |

Az√©rt l√°tszik a l√°bmennyis√©gben a k√ºl√∂nbs√©g szerintem.

Teh√°t ezek 8bitesek. Lassan tudj√°k feldolgozni az aritmetikai m≈±veleteket, ez√©rt bonyolult kialak√≠t√°s√∫ (delta, coreXY stb), vagy gyors nyomtat√≥k vez√©rl√©s√©re √∂nmag√°ban alkalmatlanok. A bonyolult nyomtat√≥kn√°l az a gond, hogy ami a gcode-nak x y √©s z koordin√°ta, az a nyomtat√≥nak XY, XZ, YZ kett≈ës koordin√°ta lesz, mert egyszerre k√©t motort kell egyenes mozg√°shoz mozgatnia. (Persze ez nagyon le van egyszer≈±s√≠tve, mert hossz√∫ t√©ma lenne) √≠gy m√©g ezeket a sz√°m√≠t√°sokat is el kell v√©geznie egy 8bites MCUnak. Kb. ez√©rt voltak nagyon kicsik √©s lass√∫ak a r√©gi delt√°k.

Na most egy alaplap, az nem m√°s, mint valamilyen √©rtelmezhet≈ë form√°ban ezeket a l√°bakat kivezetni a k√ºl√∂nb√∂z≈ë funkci√≥khoz. Pl. hasra√ºtve a 13-as pin lesz a bltouch √©rz√©kel≈ë vezet√©ke. Ez az√©rt sz√ºks√©ges, mert kellenek az MCU mell√© k√≠s√©r≈ë dolgok, mint kvarcok, meg ellen√°ll√°sok, di√≥d√°k, stb. Illetve az√©rt, hogy v√©rpistike r√° tudjon dugni egy csatlakoz√≥t, ne kelljen forrasztgatnia. A kis l√°bakra nem lenne t√∫l egyszer≈± ugye dugdosni egy motor driver √∂sszes l√°b√°t. üòÉ

No √©s akkor itt j√∂n a Marlin, ami nem csin√°l m√°st, mint megmondja a nyomtat√≥nak, hogy most az egyik motor balra, vagy jobbra tekerjen, az azt jelenti, hogy mittom√©n a 47-49 pinek ilyen, meg olyen √°llapotba ker√ºljenek. Teh√°t emberi olvashat√≥ nyelvr≈ël leford√≠tja az MCU nyelv√©re a k√≥dot, ami √©rtelmezni tudja a kapott gcode-ot √©s vez√©relni tudja a benne l√©v≈ë egys√©geket. Ami a gond, hogy ugye mivel MCU-n fut, √≠gy tud el√©g nagy sz√≠v√°s lenni a ford√≠t√°sa √©s flashel√©se. Ami az√©rt is vesz√©lyes m≈±velet, mert rossz k√≥d eset√©n ak√°r ki is √©gethet alkatr√©szeket a boardon, vagy mag√°n az MCU-n. Ezt persze a Marlin √≠r√≥i igyekeztek lev√©deni, de vannak tehets√©ges pr√≥b√°lkoz√≥k mindig.

A Marlin igazi er≈ëss√©ge a 32bites MCUkon j√∂n ki. Ezekre p√©lda az STM32 gy√°rt√≥ 32bites csipjei, melyeket el≈ëszeretettel haszn√°lnak 32bites vez√©rl≈ëk√∂n. Az√©rt ezeken p√∂r√∂g a Marlin, mert sokkal gyorsabban v√©gzik el a sz√ºks√©ges aritmetikai √©s matematikai m≈±veleteket, mint a 8bites t√°rsaik.

No akkor j√∂jj√∂n a hosszas bevezet≈ë ut√°n a Klipper. Van ugye egy RPInk. Legyen mondjuk egy RPI4. Ez b√°rmelyik alaplapban tal√°lhat√≥ MCUhoz k√©pest egy atomer≈ëm≈±. De t√©nyleg. Egy r√©gebbi laptopnak sim√°n megfelel a sz√°m√≠t√°si kapacit√°sa, teljes √©rt√©k≈± GUIval rendelkez≈ë linux OS fut rajta r√∂ccen√©s n√©lk√ºl. Am√≠g az MCU kb. sorfolytonos k√≥dokat tud majdcsak √©rtelmezni, addig a 4 magos chippel szerelt RPI ugye konkurrens sz√°lkezel√©ssel megt√°mogatott k√≥db√°zisra √©p√ºlt. Teh√°t g√∂rdeszka vs. Porsche Carrera GT.

Ami t√∂rt√©nik a Klipper telep√≠t√©sekor az az, hogy egy nagy halom Python k√≥d ker√ºl az RPI-re. A Klipper "szerveroldala" viccesen mondva. Teh√°t maga a Klipper gcode √©rtelmez≈ë motorja, az Octoprint, vagy Moonraker server backend √©s a k√©t UI, a fluidd, vagy a Mainsail egyike. Az Octoprint √©s a Moonraker abban k√ºl√∂nb√∂zik, hogy az el≈ëbbi egy teljes 3D printer manager szerveroldali app. Milli√≥ plugin, de mag√°t√≥l csak valamely RepRap alap√∫ firmwares (pl marlin) g√©ppel tud √∂sszepof√°zni. Teh√°t √∂nmag√°ban az Octo nem sz√°mol semmit sem!!!!!!! Az octo arra j√≥ pl, hogy b√∂ng√©sz≈ëb≈ël tudod etetni a nyomtat√≥dat gcode f√°jllal. Nem kell azt SD k√°rty√°ra m√°solnod √©s megdugni vele a nyomtat√≥t. Meg persze ezen k√≠v√ºl sok mindent. De a l√©nyeg, hogy tov√°bbra is valamely komplex firmware fut a nyomtat√≥don. Viszont a Klipper eredetileg egy Octoprint plugink√©nt indult, hogy a sz√°m√≠t√°st a g√∂rdeszk√°r√≥l a Porschera tegye √°t.

Itt j√∂tt a k√©pbe a Moonraker, ugyanis sokan, k√∂zt√ºk √©n is √∫gy gondolt√°k, hogy az Octo t√∂k feleslegesen van agyon csillivillizve mindenf√©le kieg√©sz√≠t≈ëvel. Fel√©t nem haszn√°lja az ember. Pont annyi √©rdekli, amit a klipper mag√°ban is tud. Erre p√°r okos meg√≠rta azt a r√©szt az Octob√≥l, ami kell ahhoz, hogy a klipper mag√°ban is m≈±k√∂dj√∂n. Kis k√≥d √©s script, illetve macro √©rtelemez≈ë, illetve ≈ë ny√∫jtja a webes UI sz√°m√°ra sz√ºks√©ges webes API v√©gpontokat is. De semmi t√∂bbet. Egy marha minimalista cucc. Csak a sz√ºks√©ges minimumot tudja. A mainsail, meg a fluidd pedig k√©t k√∂nnyen haszn√°lhat√≥ b√∂ng√©sz≈ës fel√ºlet a klipperhez. Ennyi, nem t√∂bb.

No √©s akkor hol a fen√©ben van a nyomtat√≥ alaplap firmware a Klipper eset√©ben? H√°t ott, hogy a Klipper nem csak "szerveroldali", hanem nyomtat√≥ oldali is. A Klipper telep√≠t√©se sor√°n meg kell mondani, hogy az RPI hogy √©ri el az alaplapot (Pl. USB), milyen csip van a boardon (atmega, stm32 stb.) √©s az alapj√°n ford√≠t egy hal√°l buta firmware-t. Ez csak annyit tud, hogy az MCU melyik PINj√©re, l√°b√°ra mikor kell fesz√ºlts√©get adni, vagy onnan kiolvasni a jelenlegi √©rt√©ket. Nem tudja, hogy vannak r√°dugva szenzorok, driverek, motorok stb. Csak annyi, hogy most k√©rlek az anal√≥g 37es PIN ker√ºlj√∂n HIGH √°llapotban √©s ut√°na a digit√°lis 23as PIN √©rt√©k√©t olvasd be.

A t√∂bbit a Moonraker √©s f≈ëleg a Klipper csin√°lja. A k√ºl√∂nb√∂z≈ë makr√≥kat √©rtelmezi a Moonraker, a k√ºl√∂nb√∂z≈ë gcode-okat pedig a klipper. A kett≈ët a Klipper √∂sszegy√∫rja √©s a Moonraker kitolja az utas√≠t√°sokat USB-n az alaplapra, majd a kapott v√°laszt kiolvassa √©s egy√ºtt √©rtelmezik. Mindezt az RPI csip sebess√©g√©vel.

Ez√©rt √°ltal√°ban felesleges 8bitesn√©l jobb alaplap, ha van Klipper, mert nem terhelj√ºk az MCU-t kb . semmivel. Egyed√ºl akkor j√∂n j√≥l egy 32bites, ha m√°r kev√©s a l√°b. A 32bites csipeken ak√°r 2-4x annyi l√°b van, mint egy atmega2560on. Ez√©rt lehet pl. 8 db motor driver rajtuk.

Nagyj√°b√≥l ezek lenn√©nek az elm√©leti alapok. A k√∂vetkez≈ë r√©szben √≠rok egy r√∂vid √©s t√∂m√∂r telep√≠t√©st, ahogy √©n a legegyszer≈±bbnek tartom jelenleg a Klipper multi-instance telep√≠t√©s√©t √©s karbantart√°s√°t. A kommentekben, vagy Facebookon a magyar 3D printer csoportokban megtal√°ltok a k√©rd√©seitekkel.

A nyomi legyen veletek!